<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NYC Soundscape — A Day in the Life</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #070810;
    --bg2: #0d0f1a;
    --bg3: #12152a;
    --text: #e8eaf6;
    --muted: #5a5f8a;
    --border: #1e2240;

    --c-engine:    #ff6b6b;
    --c-machinery: #ff9f43;
    --c-impact:    #ffd32a;
    --c-saw:       #26de81;
    --c-alert:     #fd79a8;
    --c-music:     #a29bfe;
    --c-voice:     #74b9ff;
    --c-dog:       #55efc4;

    --neon-a: #a29bfe;
    --neon-b: #74b9ff;
    --neon-c: #fd79a8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── HEADER ── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 28px 48px;
    border-bottom: 1px solid var(--border);
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.1rem;
    letter-spacing: 0.04em;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-dot {
    width: 8px; height: 8px;
    background: var(--neon-c);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--neon-c);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }
  .header-tag {
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  /* ── LAYOUT ── */
  .app {
    display: grid;
    grid-template-columns: 320px 1fr 300px;
    grid-template-rows: 1fr auto;
    height: calc(100vh - 73px);
    gap: 0;
  }

  /* ── LEFT PANEL: PERSONAS ── */
  .panel-left {
    border-right: 1px solid var(--border);
    padding: 32px 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .panel-label {
    font-size: 0.62rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    padding-left: 4px;
  }
  .persona-card {
    padding: 14px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .persona-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--accent);
    opacity: 0;
    transition: opacity 0.2s;
  }
  .persona-card:hover { border-color: var(--accent); background: rgba(255,255,255,0.02); }
  .persona-card:hover::before { opacity: 0.5; }
  .persona-card.active { background: rgba(255,255,255,0.04); border-color: var(--accent); }
  .persona-card.active::before { opacity: 1; }

  .persona-name {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.88rem;
    margin-bottom: 2px;
  }
  .persona-meta {
    font-size: 0.65rem;
    color: var(--muted);
    line-height: 1.6;
  }
  .persona-borough {
    display: inline-block;
    font-size: 0.58rem;
    padding: 2px 7px;
    border-radius: 20px;
    margin-top: 6px;
    border: 1px solid currentColor;
    opacity: 0.7;
  }

  /* ── CENTER: RADIAL CLOCK + INFO ── */
  .panel-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 24px;
    gap: 24px;
  }

  .clock-container {
    position: relative;
    width: 480px;
    height: 480px;
    flex-shrink: 0;
  }

  #clock-svg {
    width: 100%;
    height: 100%;
    overflow: visible;
  }

  /* hour labels */
  .hour-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    fill: var(--muted);
  }

  /* ── HOUR TOOLTIP ── */
  .hour-tooltip {
    position: absolute;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    min-width: 200px;
    z-index: 10;
    font-size: 0.72rem;
    line-height: 1.7;
  }
  .hour-tooltip.visible { opacity: 1; }
  .hour-tooltip-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    margin-bottom: 8px;
  }
  .sound-chip {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 0.6rem;
    margin: 2px 3px 2px 0;
    border: 1px solid currentColor;
  }

  /* ── JOURNEY TEXT ── */
  .journey-info {
    text-align: center;
    max-width: 380px;
  }
  .journey-hour {
    font-family: 'Syne', sans-serif;
    font-size: 3rem;
    font-weight: 800;
    line-height: 1;
    background: linear-gradient(135deg, var(--neon-a), var(--neon-b));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .journey-location {
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 6px;
    letter-spacing: 0.06em;
  }
  .journey-desc {
    font-size: 0.72rem;
    color: #9fa3c7;
    margin-top: 10px;
    line-height: 1.8;
    max-width: 340px;
  }

  /* ── RIGHT PANEL: AUDIO ── */
  .panel-right {
    border-left: 1px solid var(--border);
    padding: 32px 24px;
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  /* dB meter */
  .meter-section {}
  .meter-label-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 12px;
  }
  .meter-db-value {
    font-family: 'Syne', sans-serif;
    font-size: 2.4rem;
    font-weight: 800;
    line-height: 1;
    color: var(--text);
    transition: color 0.3s;
  }
  .meter-db-unit {
    font-size: 0.65rem;
    color: var(--muted);
    margin-left: 4px;
  }
  .meter-bar-wrap {
    height: 8px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  .meter-bar-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, #26de81, #ffd32a, #ff6b6b);
    width: 0%;
    transition: width 0.05s;
  }
  .meter-ticks {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: 0.55rem;
    color: var(--muted);
  }

  /* waveform */
  .waveform-section {}
  #waveform-canvas {
    width: 100%;
    height: 100px;
    border-radius: 8px;
    background: var(--bg3);
    display: block;
  }

  /* sounds in this hour */
  .sounds-section {}
  .sounds-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }
  .sound-row {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid transparent;
    transition: all 0.15s;
  }
  .sound-row:hover { background: rgba(255,255,255,0.03); border-color: var(--border); }
  .sound-row.playing { background: rgba(255,255,255,0.05); border-color: var(--accent-color,#a29bfe); }
  .sound-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 6px currentColor;
  }
  .sound-name { font-size: 0.7rem; flex: 1; }
  .sound-play-btn {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 0.08em;
  }
  .sound-row:hover .sound-play-btn { color: var(--text); }
  .sound-row.playing .sound-play-btn { color: var(--neon-c); }

  /* play/stop global */
  .playback-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .playback-btn:hover { border-color: var(--neon-a); color: var(--neon-a); }
  .playback-btn.active { background: var(--bg3); border-color: var(--neon-c); color: var(--neon-c); }

  /* legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.6rem;
    color: var(--muted);
  }
  .legend-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
  }

  /* scrub timeline */
  .timeline-strip {
    display: flex;
    align-items: center;
    gap: 0;
    height: 32px;
    position: relative;
    cursor: pointer;
    margin-top: 4px;
  }
  .timeline-hour-cell {
    flex: 1;
    height: 100%;
    border-right: 1px solid var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.5rem;
    color: transparent;
    transition: all 0.15s;
    border-radius: 2px;
  }
  .timeline-hour-cell:hover { color: var(--muted); filter: brightness(1.3); }
  .timeline-hour-cell.current { outline: 1px solid white; outline-offset: -1px; }

  /* animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeIn 0.35s ease forwards; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ── BOTTOM STATUS BAR ── */
  .statusbar {
    grid-column: 1 / -1;
    border-top: 1px solid var(--border);
    padding: 10px 48px;
    display: flex;
    align-items: center;
    gap: 32px;
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 0.08em;
  }
  .statusbar span { display: flex; align-items: center; gap: 6px; }
  .status-live {
    width: 6px; height: 6px;
    background: #26de81;
    border-radius: 50%;
    box-shadow: 0 0 8px #26de81;
    animation: pulse 1.5s ease-in-out infinite;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    NYC SOUNDSCAPE
  </div>
  <div class="header-tag">SONYC Urban Sound Tagging · NYU · Data Visualization 2026</div>
</header>

<div class="app">

  <!-- LEFT: PERSONAS -->
  <div class="panel-left">
    <div class="panel-label">Select a New Yorker</div>
    <div id="persona-list"></div>
  </div>

  <!-- CENTER: CLOCK -->
  <div class="panel-center">
    <div class="clock-container">
      <svg id="clock-svg" viewBox="-260 -260 520 520"></svg>
      <div class="hour-tooltip" id="hour-tooltip">
        <div class="hour-tooltip-title" id="tt-title"></div>
        <div id="tt-sounds"></div>
        <div id="tt-desc" style="color:var(--muted);font-size:0.65rem;margin-top:6px;line-height:1.6"></div>
      </div>
    </div>

    <!-- timeline scrubber -->
    <div style="width:100%;max-width:480px;">
      <div class="panel-label" style="margin-bottom:8px">SCRUB TIMELINE</div>
      <div class="timeline-strip" id="timeline-strip"></div>
      <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:4px">
        <span>12AM</span><span>6AM</span><span>12PM</span><span>6PM</span><span>11PM</span>
      </div>
    </div>

    <!-- current hour info -->
    <div class="journey-info fade-in" id="journey-info">
      <div class="journey-hour" id="journey-hour-text">—</div>
      <div class="journey-location" id="journey-location-text">Select a persona to begin</div>
      <div class="journey-desc" id="journey-desc-text">Hover over the clock to explore the soundscape of a New Yorker's day.</div>
    </div>
  </div>

  <!-- RIGHT: AUDIO + METER -->
  <div class="panel-right">
    <div class="panel-label">Sound Monitor</div>

    <!-- dB meter -->
    <div class="meter-section">
      <div class="meter-label-row">
        <span class="panel-label" style="margin-bottom:0">DECIBEL LEVEL</span>
        <div>
          <span class="meter-db-value" id="db-value">—</span>
          <span class="meter-db-unit">dB</span>
        </div>
      </div>
      <div class="meter-bar-wrap">
        <div class="meter-bar-fill" id="meter-fill"></div>
      </div>
      <div class="meter-ticks">
        <span>40</span><span>55</span><span>70</span><span>85</span><span>100+</span>
      </div>
    </div>

    <!-- waveform -->
    <div class="waveform-section">
      <div class="panel-label" style="margin-bottom:10px">WAVEFORM</div>
      <canvas id="waveform-canvas"></canvas>
    </div>

    <!-- sounds list -->
    <div class="sounds-section" style="flex:1;overflow-y:auto">
      <div class="panel-label">SOUNDS THIS HOUR</div>
      <div class="sounds-list" id="sounds-list">
        <div style="color:var(--muted);font-size:0.68rem;margin-top:8px">Select a persona & hour to explore sounds.</div>
      </div>
    </div>

    <!-- play btn -->
    <button class="playback-btn" id="play-btn" onclick="toggleAutoPlay()">▶ AUTO-PLAY DAY</button>

    <!-- legend -->
    <div>
      <div class="panel-label" style="margin-bottom:8px">SOUND TAXONOMY</div>
      <div class="legend" id="legend"></div>
    </div>
  </div>

  <div class="statusbar">
    <span><span class="status-live"></span> SONYC Sensor Network · NYC</span>
    <span>Dataset: SONYC-UST v2.3 · Zenodo 3966543</span>
    <span>23 Fine-grained Classes · 8 Coarse Classes</span>
    <span id="status-persona">No persona selected</span>
  </div>
</div>

<script>
// ─────────────────────────────────────────────
// DATA: SOUND TAXONOMY
// ─────────────────────────────────────────────
const SOUND_COLORS = {
  'engine':        '#ff6b6b',
  'machinery':     '#ff9f43',
  'impact':        '#ffd32a',
  'saw':           '#26de81',
  'alert':         '#fd79a8',
  'music':         '#a29bfe',
  'busking':       '#c49bfe', // active performance — warmer purple than ambient music
  'voice':         '#74b9ff',
  'dog':           '#55efc4',
};

const SOUND_FINE = {
  'engine': ['small engine','medium engine','large engine'],
  'machinery': ['rock drill','jackhammer','hoe-ram','pile driver'],
  'impact': ['non-machinery impact'],
  'saw': ['chainsaw','rotating saw'],
  'alert': ['car horn','car alarm','siren','reverse beeper'],
  'music': ['stationary music','mobile music','ice cream truck'],
  'voice': ['talking','shouting','crowd','amplified speech'],
  'dog': ['dog barking'],
};

// ─────────────────────────────────────────────
// DATA: PERSONAS
// Grounded in SONYC dataset geography (Manhattan, Brooklyn, Queens)
// Hour data shaped by the actual sound taxonomy + spatiotemporal patterns
// ─────────────────────────────────────────────
const PERSONAS = [
  {
    id: 'maya',
    name: 'Maya',
    role: 'CS Undergrad · Tandon',
    borough: 'Elmhurst, Queens',
    color: '#ffd32a',
    schedule: [
      { h:0,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'No sensor data for Queens overnight. The neighborhood is quiet but unmeasured.' },
      { h:1,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'Still asleep. No Queens sensor coverage at this hour.' },
      { h:2,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'Deep night. Data blind spot — one sensor in all of Queens.' },
      { h:3,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'Nothing recorded here at 3am. Just the city breathing.' },
      { h:4,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'Pre-dawn. Sensor offline for the night.' },
      { h:5,  loc:'Home — Elmhurst',          sounds:[],                      db:35, noData:true, desc:'Alarm goes off soon. Still no coverage.' },
      { h:6,  loc:'Home — Elmhurst',          sounds:['engine'],              db:52, desc:'Queens Blvd traffic picks up. Getting dressed.' },
      { h:7,  loc:'Elmhurst Ave F Station',   sounds:['engine','alert'],      db:68, desc:'Walking to the subway. Buses, cars, crosswalk beeps.' },
      { h:8,  loc:'F Train → Jay St',         sounds:['engine','voice'],      db:80, desc:'Packed F train. Metal on rails, people, phone calls.' },
      { h:9,  loc:'Tandon — Rogers Hall',     sounds:['voice'],               db:62, desc:'First lecture of the day. Settling in, professor getting started.' },
      { h:10, loc:'Tandon — CS Lab',          sounds:['voice','machinery'],   db:58, desc:'Lab session. Fans humming, someone drilling outside.' },
      { h:11, loc:'Tandon — Atrium',          sounds:['voice','engine'],      db:64, desc:'Between classes. Busy atrium, traffic audible from the street.' },
      { h:12, loc:'MetroTech Plaza',          sounds:['voice','engine'],      db:68, desc:'Lunch outside. Food trucks, people, delivery vans.' },
      { h:13, loc:'Tandon — Lecture Hall',    sounds:['voice'],               db:56, desc:'Afternoon class. Quiet except for one person eating loudly.' },
      { h:14, loc:'Tandon — Study Room',      sounds:['voice'],               db:52, desc:'Group project. Collaborative but contained.' },
      { h:15, loc:'Tandon — Courtyard',       sounds:['engine','alert','voice'],db:68, desc:'Outside break. Trucks reversing at loading dock nearby.' },
      { h:16, loc:'Tandon — Club Room',       sounds:['voice','music'],       db:60, desc:'Club meeting. Someone brought a speaker.' },
      { h:17, loc:'Jay St Station',           sounds:['engine','voice'],      db:74, desc:'Heading home. Rush hour platform, crowded.' },
      { h:18, loc:'F Train → Elmhurst',       sounds:['engine','voice'],      db:78, desc:'Packed train. Standing room only, loud.' },
      { h:19, loc:'Home — Elmhurst',          sounds:['voice','engine'],      db:65, desc:'Back in Queens. Neighborhood energy, family nearby.' },
      { h:20, loc:'Home — Elmhurst',          sounds:['voice','music'],       db:58, desc:'Dinner, studying. Roommates on TV in the other room.' },
      { h:21, loc:'Queens Blvd',              sounds:['engine','alert'],      db:65, desc:'Late food run. Queens Blvd never really quiets down.' },
      { h:22, loc:'Home — Elmhurst',          sounds:['voice','music'],       db:56, desc:'Back home. Neighbors above, music faint.' },
      { h:23, loc:'Home — Elmhurst',          sounds:['engine'],              db:48, desc:'Trying to sleep. Boulevard hum in the background.' },
    ]
  },
  {
    id: 'marcus',
    name: 'Prof. Marcus',
    role: 'Urban Studies Faculty · WSP',
    borough: 'Upper East Side',
    color: '#74b9ff',
    schedule: [
      { h:0,  loc:'Home — UES',               sounds:['engine'],              db:44, desc:'Late night on 2nd Ave. Cab, distant bus.' },
      { h:1,  loc:'Home — UES',               sounds:['engine'],              db:42, desc:'Quiet now. A truck.' },
      { h:2,  loc:'Home — UES',               sounds:[],                      db:38, desc:'Still. Rare for Manhattan.' },
      { h:3,  loc:'Home — UES',               sounds:[],                      db:36, desc:'Deepest quiet of the night.' },
      { h:4,  loc:'Home — UES',               sounds:['engine'],              db:42, desc:'Delivery trucks starting their rounds.' },
      { h:5,  loc:'Home — UES',               sounds:['engine','voice'],      db:50, desc:'Building staff, street cleaner going by.' },
      { h:6,  loc:'Home — UES',               sounds:['engine','voice'],      db:55, desc:'Morning routine. Coffee, news on low.' },
      { h:7,  loc:'6 Train — Downtown',       sounds:['engine','voice','alert'],db:82, desc:'Rush hour 6 train. Packed, screeching at the curve.' },
      { h:8,  loc:'Washington Square Park',   sounds:['voice','dog','music'], db:70, desc:'Walking through WSP to the office. Buskers tuning up, dogs everywhere.' },
      { h:9,  loc:'Silver Center — NYU',      sounds:['voice'],               db:58, desc:'Office hours. Students stopping by, phone on silent.' },
      { h:10, loc:'Silver Center — NYU',      sounds:['voice'],               db:62, desc:'Seminar prep. Colleagues in the hall.' },
      { h:11, loc:'Lecture Hall — NYU',       sounds:['voice'],               db:64, desc:'Teaching. Big room, forty students, good discussion today.' },
      { h:12, loc:'West Village — Lunch',     sounds:['voice','music','alert'],db:70, desc:'Lunch with a colleague. Outdoor seating, ambulance passes.' },
      { h:13, loc:'Silver Center — NYU',      sounds:['voice'],               db:58, desc:'More office hours. Steady stream of students.' },
      { h:14, loc:'Faculty Meeting — NYU',    sounds:['voice'],               db:55, desc:'Conference room. Lot of talking, not much resolved.' },
      { h:15, loc:'Washington Square Park',   sounds:['voice','dog','music'], db:68, desc:'Grading on a bench. Dogs, a guitarist, kids on the fountain.' },
      { h:16, loc:'Silver Center — NYU',      sounds:['voice','machinery'],   db:60, desc:'Back at desk. Construction audible from the window on 3rd.' },
      { h:17, loc:'6 Train — Uptown',         sounds:['engine','voice','alert'],db:80, desc:'Heading home. Still packed going north.' },
      { h:18, loc:'Home — UES',               sounds:['voice','engine'],      db:62, desc:'Back home. Neighbor in the hall, street noise.' },
      { h:19, loc:'Restaurant — UES',         sounds:['voice','music'],       db:68, desc:'Dinner out. Neighborhood place, good noise level.' },
      { h:20, loc:'Home — UES',               sounds:['voice'],               db:55, desc:'Reading. TV on low in another room.' },
      { h:21, loc:'Home — UES',               sounds:['engine'],              db:50, desc:'Winding down. 2nd Ave outside.' },
      { h:22, loc:'Home — UES',               sounds:['engine'],              db:46, desc:'Late night. Quiet now.' },
      { h:23, loc:'Home — UES',               sounds:['engine'],              db:42, desc:'Almost asleep.' },
    ]
  },
  {
    id: 'keisha',
    name: 'Keisha',
    role: 'Dog Walker · WSP',
    borough: 'West Village',
    color: '#55efc4',
    schedule: [
      { h:0,  loc:'Home — West Village',      sounds:['music','engine'],      db:55, desc:'Bar on Bleecker still going. Music through the wall.' },
      { h:1,  loc:'Home — West Village',      sounds:['music'],               db:52, desc:'Last call crowd outside. Music fading.' },
      { h:2,  loc:'Home — West Village',      sounds:['engine'],              db:47, desc:'Block quieting down. A cab.' },
      { h:3,  loc:'Home — West Village',      sounds:['engine'],              db:44, desc:'Almost silent. One car.' },
      { h:4,  loc:'Home — West Village',      sounds:[],                      db:40, desc:'Quiet. Even the Village sleeps eventually.' },
      { h:5,  loc:'Home — West Village',      sounds:['engine'],              db:44, desc:'First delivery trucks. Getting up soon.' },
      { h:6,  loc:'Washington Square Park',   sounds:['dog','voice'],         db:58, desc:'First walk of the day. Off-leash hour, three dogs, dewy grass.' },
      { h:7,  loc:'Washington Square Park',   sounds:['dog','music','voice'], db:65, desc:'Park filling up. Busker on guitar, dogs everywhere, runners.' },
      { h:8,  loc:'West Village Streets',     sounds:['dog','engine'],        db:62, desc:'Dropping the morning clients off. Good dogs today.' },
      { h:9,  loc:'Silver Center — NYU',      sounds:['voice'],               db:60, desc:'Morning class. Running a little late from the walks.' },
      { h:10, loc:'Silver Center — NYU',      sounds:['voice'],               db:57, desc:'Still in class. Trying to focus.' },
      { h:11, loc:'Washington Square Park',   sounds:['dog','voice','music'], db:68, desc:'Midday walks. Four dogs, two of them know each other.' },
      { h:12, loc:'Washington Square Park',   sounds:['dog','music','voice','alert'],db:73, desc:'Peak park hour. Every dog in the Village is here. A siren.' },
      { h:13, loc:'Bleecker St — Lunch',      sounds:['voice','music'],       db:66, desc:'Quick lunch. Sandwich place, music on.' },
      { h:14, loc:'Washington Square Park',   sounds:['dog','voice'],         db:63, desc:'Afternoon rounds. Calmer today, overcast.' },
      { h:15, loc:'Washington Square Park',   sounds:['dog','music','voice'], db:72, desc:'After school rush. Kids, skateboards, dogs, a trumpet.' },
      { h:16, loc:'Washington Square Park',   sounds:['dog','music','alert'], db:70, desc:'Ice cream truck rolls in. Dogs go absolutely feral.' },
      { h:17, loc:'West Village Streets',     sounds:['dog','voice','engine'],db:65, desc:'Evening walks. Last round of clients.' },
      { h:18, loc:'Home — West Village',      sounds:['voice','music'],       db:60, desc:'Home. Cooking, music on.' },
      { h:19, loc:'Home — West Village',      sounds:['voice'],               db:56, desc:'Studying for class tomorrow.' },
      { h:20, loc:'Home — West Village',      sounds:['dog','voice'],         db:58, desc:'Neighbor\'s dog barking down the hall.' },
      { h:21, loc:'Home — West Village',      sounds:['music'],               db:55, desc:'Playlist on. Reading.' },
      { h:22, loc:'Home — West Village',      sounds:['music','engine'],      db:58, desc:'Bar getting loud again. It\'s Wednesday but whatever.' },
      { h:23, loc:'Home — West Village',      sounds:['music'],               db:54, desc:'Drifting off. Still audible from downstairs.' },
    ]
  },
  {
    id: 'carlos',
    name: 'Carlos',
    role: 'Facilities Crew · Tandon',
    borough: 'Sunset Park, Bk',
    color: '#ff9f43',
    schedule: [
      { h:0,  loc:'Home — Sunset Park',       sounds:['engine'],              db:48, desc:'Traffic on 4th Ave. Quiet block otherwise.' },
      { h:1,  loc:'Home — Sunset Park',       sounds:['engine'],              db:46, desc:'Asleep. Distant highway.' },
      { h:2,  loc:'Home — Sunset Park',       sounds:[],                      db:42, desc:'Silent.' },
      { h:3,  loc:'Home — Sunset Park',       sounds:[],                      db:40, desc:'Deep sleep.' },
      { h:4,  loc:'Home — Sunset Park',       sounds:['engine'],              db:44, desc:'Early trucks on 3rd Ave.' },
      { h:5,  loc:'Home — Sunset Park',       sounds:['engine','voice'],      db:54, desc:'Up early. Street outside waking up, neighbor\'s door.' },
      { h:6,  loc:'D Train → Atlantic Ave',   sounds:['engine','voice'],      db:76, desc:'Subway in. Not too crowded yet.' },
      { h:7,  loc:'Tandon — Site Prep',       sounds:['machinery','engine'],  db:72, desc:'On site early. Setting up equipment, truck unloading.' },
      { h:8,  loc:'Tandon — Construction',    sounds:['machinery','impact'],  db:85, desc:'Work starts. Compacting, breaking ground.' },
      { h:9,  loc:'Tandon — Construction',    sounds:['machinery','impact'],  db:88, desc:'Jackhammer on the utility trench. Loud day.' },
      { h:10, loc:'Tandon — Construction',    sounds:['saw','machinery'],     db:86, desc:'Cutting steel framing. Saw whine, sparks.' },
      { h:11, loc:'Tandon — Construction',    sounds:['machinery','saw','impact'],db:84, desc:'All at once for a bit. Coordinating with another crew.' },
      { h:12, loc:'MetroTech — Lunch',        sounds:['voice','engine'],      db:65, desc:'Lunch on the plaza. Feet up, sandwich, trucks going by.' },
      { h:13, loc:'Tandon — Construction',    sounds:['machinery','saw'],     db:83, desc:'Back at it. Afternoon cutting.' },
      { h:14, loc:'Tandon — Construction',    sounds:['machinery','alert','impact'],db:80, desc:'Loading dock activity. Reverse beepers, big delivery.' },
      { h:15, loc:'Tandon — Construction',    sounds:['saw','machinery'],     db:83, desc:'Pipe cuts. Long afternoon.' },
      { h:16, loc:'Tandon — Wrap-up',         sounds:['machinery','engine'],  db:74, desc:'Cleaning up. Equipment powered down, truck reversing out.' },
      { h:17, loc:'D Train → Sunset Park',    sounds:['engine','voice'],      db:74, desc:'Heading home. Rush hour but he gets a seat.' },
      { h:18, loc:'Home — Sunset Park',       sounds:['voice','engine'],      db:60, desc:'Home. Kids outside, dinner smells.' },
      { h:19, loc:'Home — Sunset Park',       sounds:['voice','music'],       db:58, desc:'Dinner. TV on, family around.' },
      { h:20, loc:'Home — Sunset Park',       sounds:['voice'],               db:54, desc:'Winding down. Quiet evening.' },
      { h:21, loc:'Home — Sunset Park',       sounds:['engine'],              db:48, desc:'Almost out. 4th Ave traffic.' },
      { h:22, loc:'Home — Sunset Park',       sounds:['engine'],              db:46, desc:'Asleep.' },
      { h:23, loc:'Home — Sunset Park',       sounds:['engine'],              db:44, desc:'Late night. Trucks on the avenue.' },
    ]
  },
  {
    id: 'amara',
    name: 'Amara',
    role: 'Music MFA · Busker · WSP',
    borough: 'Bed-Stuy, Bk',
    color: '#a29bfe',
    schedule: [
      { h:0,  loc:'Home — Bed-Stuy',          sounds:['music','voice'],       db:65, desc:'Just got in from a gig. Neighbors still up, music through the floor.' },
      { h:1,  loc:'Home — Bed-Stuy',          sounds:['music','engine'],      db:58, desc:'Winding down. Music on low.' },
      { h:2,  loc:'Home — Bed-Stuy',          sounds:['engine'],              db:46, desc:'Asleep. L train rumbles past.' },
      { h:3,  loc:'Home — Bed-Stuy',          sounds:['engine'],              db:44, desc:'Quiet block. Occasional car.' },
      { h:4,  loc:'Home — Bed-Stuy',          sounds:[],                      db:40, desc:'Still.' },
      { h:5,  loc:'Home — Bed-Stuy',          sounds:['engine'],              db:44, desc:'First bus. Stirring.' },
      { h:6,  loc:'Home — Bed-Stuy',          sounds:['voice','engine'],      db:52, desc:'Slow morning. Neighbor in the hall.' },
      { h:7,  loc:'Home — Bed-Stuy',          sounds:['voice','engine'],      db:55, desc:'Getting ready. Music on while making coffee.' },
      { h:8,  loc:'A Train → West 4th',       sounds:['engine','voice','music'],db:78, desc:'Subway to WSP. Someone\'s playing in the car.' },
      { h:9,  loc:'NYU Music Building',       sounds:['music','voice'],       db:65, desc:'Practice room. Working on a new piece.' },
      { h:10, loc:'NYU — Composition Class',  sounds:['music','voice'],       db:62, desc:'Class. Everyone playing something different in their head.' },
      { h:11, loc:'NYU — Ensemble Rehearsal', sounds:['music','voice'],       db:68, desc:'Rehearsal. Full group today, actually sounding good.' },
      { h:12, loc:'West Village — Lunch',     sounds:['voice','music','alert'],db:70, desc:'Lunch near campus. Street noise, a car alarm briefly.' },
      { h:13, loc:'Washington Square Park',   sounds:['busking','voice'],          db:66, desc:'Setting up the busking spot. Good crowd already.' },
      { h:14, loc:'Washington Square Park',   sounds:['busking','voice','alert'],  db:73, desc:'Playing. Crowd gathering. Someone tries to talk over her.' },
      { h:15, loc:'Washington Square Park',   sounds:['busking','voice','dog'],    db:76, desc:'Peak hour. Biggest crowd of the day. Dogs keep stopping to listen.' },
      { h:16, loc:'Washington Square Park',   sounds:['busking','voice','alert'],  db:74, desc:'Still going. Kids from school, tourists, regulars.' },
      { h:17, loc:'Washington Square Park',   sounds:['busking','voice','engine','alert'],db:77, desc:'Rush hour around the park. Busiest sonic moment of the day.' },
      { h:18, loc:'A Train → Bed-Stuy',       sounds:['engine','voice'],      db:78, desc:'Heading home, gear in tow.' },
      { h:19, loc:'Home — Bed-Stuy',          sounds:['voice','music'],       db:63, desc:'Home. Neighbor practicing bass. She doesn\'t mind.' },
      { h:20, loc:'Home — Bed-Stuy',          sounds:['music','voice'],       db:70, desc:'Jam session with the neighbor. Kitchen turned studio.' },
      { h:21, loc:'Home — Bed-Stuy',          sounds:['music','voice'],       db:66, desc:'Still going. Lost track of time.' },
      { h:22, loc:'Home — Bed-Stuy',          sounds:['music'],               db:60, desc:'Winding down. Playing quietly now.' },
      { h:23, loc:'Home — Bed-Stuy',          sounds:['music','engine'],      db:55, desc:'Late. Headphones on. L train.' },
    ]
  },
  {
    id: 'lin',
    name: 'Dr. Lin',
    role: 'CUSP Researcher · Tandon',
    borough: 'Carroll Gardens, Bk',
    color: '#26de81',
    schedule: [
      { h:0,  loc:'Home — Carroll Gardens',   sounds:['engine'],              db:46, desc:'Smith St quiet. Occasional car.' },
      { h:1,  loc:'Home — Carroll Gardens',   sounds:[],                      db:40, desc:'Asleep.' },
      { h:2,  loc:'Home — Carroll Gardens',   sounds:[],                      db:38, desc:'Still.' },
      { h:3,  loc:'Home — Carroll Gardens',   sounds:[],                      db:36, desc:'Quiet neighborhood at 3am.' },
      { h:4,  loc:'Home — Carroll Gardens',   sounds:['engine'],              db:42, desc:'Early delivery on Court St.' },
      { h:5,  loc:'Home — Carroll Gardens',   sounds:['engine','voice'],      db:50, desc:'Up early. Getting ready.' },
      { h:6,  loc:'Home — Carroll Gardens',   sounds:['voice','engine'],      db:54, desc:'Coffee, checking data from overnight jobs.' },
      { h:7,  loc:'F Train → Jay St',         sounds:['engine','voice'],      db:76, desc:'Subway in. Reading on the train.' },
      { h:8,  loc:'Tandon — CUSP Lab',        sounds:['voice'],               db:58, desc:'In the lab early. Good time to think.' },
      { h:9,  loc:'Tandon — CUSP Lab',        sounds:['voice'],               db:60, desc:'Team standup. Everyone updating each other on their models.' },
      { h:10, loc:'Tandon — CUSP Lab',        sounds:['voice','engine'],      db:55, desc:'Data pipeline running. Machine hum, Carlos\'s crew audible outside.' },
      { h:11, loc:'Tandon — CUSP Lab',        sounds:['voice','machinery'],   db:60, desc:'Construction from across the building. Hard to ignore.' },
      { h:12, loc:'MetroTech — Lunch',        sounds:['voice','engine'],      db:66, desc:'Lunch outside. Sitting near the fountain.' },
      { h:13, loc:'Tandon — Seminar',         sounds:['voice'],               db:58, desc:'Guest lecture. Good one today.' },
      { h:14, loc:'Tandon — CUSP Lab',        sounds:['voice','machinery'],   db:57, desc:'Writing. Construction still going but tuning it out.' },
      { h:15, loc:'Tandon — CUSP Lab',        sounds:['voice'],               db:52, desc:'Quiet stretch. Deep work.' },
      { h:16, loc:'MetroTech — Walk',         sounds:['engine','voice','alert'],db:65, desc:'Short walk outside. Clearing the head.' },
      { h:17, loc:'F Train → Carroll Gardens',sounds:['engine','voice'],      db:74, desc:'Heading home. Easier commute going this direction.' },
      { h:18, loc:'Home — Carroll Gardens',   sounds:['voice','music'],       db:63, desc:'Back home. Neighbor\'s cooking, music.' },
      { h:19, loc:'Smith St — Dinner',        sounds:['voice','music'],       db:70, desc:'Dinner out. Lively block, restaurant full.' },
      { h:20, loc:'Home — Carroll Gardens',   sounds:['voice'],               db:58, desc:'Home, reading.' },
      { h:21, loc:'Home — Carroll Gardens',   sounds:['engine'],              db:50, desc:'Quiet evening.' },
      { h:22, loc:'Home — Carroll Gardens',   sounds:['engine'],              db:47, desc:'Late. Winding down.' },
      { h:23, loc:'Home — Carroll Gardens',   sounds:['engine'],              db:44, desc:'Asleep soon.' },
    ]
  },
  {
    id: 'jordan',
    name: 'Jordan',
    role: 'Night Security · Tandon',
    borough: 'Bushwick, Bk',
    color: '#fd79a8',
    schedule: [
      { h:0,  loc:'Tandon — Security Desk',   sounds:['engine'],              db:50, desc:'Midnight. Lobby quiet. Hum of the building systems.' },
      { h:1,  loc:'Tandon — Rounds',          sounds:['engine'],              db:46, desc:'Walking the floors. Empty hallways, lights on timers.' },
      { h:2,  loc:'Tandon — Security Desk',   sounds:['engine','alert'],      db:48, desc:'Back at the desk. A motion sensor trips, nothing there.' },
      { h:3,  loc:'Tandon — Rounds',          sounds:['engine'],              db:44, desc:'Quietest hour. Just the HVAC.' },
      { h:4,  loc:'Tandon — Loading Dock',    sounds:['machinery','engine','alert'],db:52, desc:'Early delivery crew shows up. Reverse beepers, truck.' },
      { h:5,  loc:'Tandon — Security Desk',   sounds:['engine'],              db:50, desc:'Last hour of shift. Counting down.' },
      { h:6,  loc:'L/M Train → Bushwick',     sounds:['engine','voice'],      db:72, desc:'Commute home. Subway filling up already.' },
      { h:7,  loc:'Home — Bushwick',          sounds:['engine','music'],      db:60, desc:'Arrived. Block waking up. Someone\'s playing music.' },
      { h:8,  loc:'Home — Bushwick',          sounds:['voice','engine'],      db:58, desc:'Trying to sleep. Neighbors leaving for work.' },
      { h:9,  loc:'Home — Bushwick',          sounds:['engine'],              db:50, desc:'Asleep. Street noise through the window.' },
      { h:10, loc:'Home — Bushwick',          sounds:['engine'],              db:48, desc:'Still out.' },
      { h:11, loc:'Home — Bushwick',          sounds:['engine','machinery'],  db:52, desc:'Something woke up. Construction nearby.' },
      { h:12, loc:'Home — Bushwick',          sounds:['voice','engine'],      db:58, desc:'Up for a bit. Coffee, check the phone.' },
      { h:13, loc:'Home — Bushwick',          sounds:['voice','music'],       db:58, desc:'Eating. TV on.' },
      { h:14, loc:'Bushwick Streets',         sounds:['engine','voice','music'],db:65, desc:'Running errands. Neighborhood active in the afternoon.' },
      { h:15, loc:'Home — Bushwick',          sounds:['voice','music'],       db:60, desc:'Back home. Getting ready for the night eventually.' },
      { h:16, loc:'Home — Bushwick',          sounds:['voice'],               db:55, desc:'Quiet time before the shift. Reading.' },
      { h:17, loc:'Home — Bushwick',          sounds:['voice','music'],       db:58, desc:'Dinner. Music on.' },
      { h:18, loc:'L/M Train → Tandon',       sounds:['engine','voice','alert'],db:74, desc:'Commute in. Evening subway.' },
      { h:19, loc:'Tandon — Pre-shift',       sounds:['voice','engine'],      db:62, desc:'Arrived early. Handoff from the day person.' },
      { h:20, loc:'Tandon — Security Desk',   sounds:['engine','alert'],      db:62, desc:'Shift started. Building winding down.' },
      { h:21, loc:'Tandon — Rounds',          sounds:['alert','engine'],      db:58, desc:'Evening rounds. Few people still in labs.' },
      { h:22, loc:'Tandon — Security Desk',   sounds:['engine'],              db:55, desc:'Quieting down. Last researchers leaving.' },
      { h:23, loc:'Tandon — Rounds',          sounds:['engine','alert'],      db:52, desc:'Almost empty. One more sweep.' },
    ]
  },
  {
    id: 'rosa',
    name: 'Rosa',
    role: 'Food Cart Vendor · WSP',
    borough: 'Lower East Side',
    color: '#ff6b6b',
    schedule: [
      { h:0,  loc:'Home — LES',               sounds:['music','engine'],      db:60, desc:'LES late night. Bar crowd outside, music leaking out.' },
      { h:1,  loc:'Home — LES',               sounds:['music','voice'],       db:58, desc:'Still going out there. She\'s used to it.' },
      { h:2,  loc:'Home — LES',               sounds:['engine'],              db:52, desc:'Quieter now. Ubers idling.' },
      { h:3,  loc:'Home — LES',               sounds:['engine'],              db:48, desc:'Almost silent.' },
      { h:4,  loc:'Home — LES',               sounds:['engine'],              db:46, desc:'Alarm soon. Delivery trucks starting.' },
      { h:5,  loc:'Home — LES',               sounds:['engine','voice'],      db:55, desc:'Up early. Prepping the cart, neighbor also up.' },
      { h:6,  loc:'Walking to WSP',           sounds:['engine','alert'],      db:65, desc:'Rolling the cart over. Few trucks still making deliveries.' },
      { h:7,  loc:'Washington Square — Setup', sounds:['voice','engine'],     db:67, desc:'Setting up. A couple regulars already waiting.' },
      { h:8,  loc:'Washington Square — Cart',  sounds:['voice','alert','engine'],db:72, desc:'Morning coffee rush. Students, faculty, dog walkers.' },
      { h:9,  loc:'Washington Square — Cart',  sounds:['voice','engine','alert'],db:70, desc:'Steady stream. Knows most of the morning people by now.' },
      { h:10, loc:'Washington Square — Cart',  sounds:['voice','music'],      db:67, desc:'Slowing a little. A busker started up nearby.' },
      { h:11, loc:'Washington Square — Cart',  sounds:['voice','engine'],     db:65, desc:'Pre-lunch quiet. Restocking.' },
      { h:12, loc:'Washington Square — Cart',  sounds:['voice','alert','music'],db:75, desc:'Lunch rush. Biggest crowd of the day. Everyone moving fast.' },
      { h:13, loc:'Washington Square — Cart',  sounds:['voice','music','dog'],db:70, desc:'Post-lunch. Lingerers, dogs, a group of tourists.' },
      { h:14, loc:'Washington Square — Cart',  sounds:['voice','music','dog'],db:64, desc:'Slow afternoon. Good for catching up.' },
      { h:15, loc:'Washington Square — Cart',  sounds:['voice','dog','music'],db:67, desc:'After-school crowd arrives. Energy picks up.' },
      { h:16, loc:'Washington Square — Cart',  sounds:['dog','music','alert'],db:70, desc:'Ice cream truck rolls past. Her regulars stay loyal.' },
      { h:17, loc:'Washington Square — Cart',  sounds:['voice','engine','alert'],db:73, desc:'Evening rush through the park. Commuters cutting across.' },
      { h:18, loc:'Walking home — LES',        sounds:['engine','voice'],     db:65, desc:'Packing up, heading back. Tired legs.' },
      { h:19, loc:'Home — LES',               sounds:['voice','music'],       db:60, desc:'Home. Family, food, phone calls.' },
      { h:20, loc:'Home — LES',               sounds:['voice','music'],       db:62, desc:'LES evening. Music from the restaurant downstairs.' },
      { h:21, loc:'Home — LES',               sounds:['music','engine'],      db:64, desc:'Neighborhood picking up. A few bars getting busy.' },
      { h:22, loc:'Home — LES',               sounds:['music','voice'],       db:62, desc:'It\'s a thing on this block. She\'s asleep through it mostly.' },
      { h:23, loc:'Home — LES',               sounds:['music','engine'],      db:58, desc:'Late. The city keeps going either way.' },
    ]
  },
];

// ─────────────────────────────────────────────
// STATE
// ─────────────────────────────────────────────
let selectedPersona = null;
let selectedHour = 8;
let autoPlayInterval = null;
let isAutoPlaying = false;

// Audio
let audioCtx = null;
let currentSoundNodes = [];
let animFrameId = null;
let analyserNode = null;
let waveformData = null;

// ─────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────
function init() {
  renderLegend();
  renderPersonas();
  renderTimeline();
  drawClock();
  resizeWaveform();
  window.addEventListener('resize', resizeWaveform);
}

// ─────────────────────────────────────────────
// LEGEND
// ─────────────────────────────────────────────
function renderLegend() {
  const el = document.getElementById('legend');
  el.innerHTML = Object.entries(SOUND_COLORS).map(([k,c]) =>
    `<div class="legend-item">
      <div class="legend-dot" style="background:${c};box-shadow:0 0 4px ${c}"></div>
      <span>${k}</span>
    </div>`
  ).join('');
}

// ─────────────────────────────────────────────
// PERSONAS
// ─────────────────────────────────────────────
function renderPersonas() {
  const el = document.getElementById('persona-list');
  el.innerHTML = PERSONAS.map(p =>
    `<div class="persona-card" id="persona-${p.id}" style="--accent:${p.color}" onclick="selectPersona('${p.id}')">
      <div class="persona-name" style="color:${p.color}">${p.name}</div>
      <div class="persona-meta">${p.role}</div>
      <span class="persona-borough" style="color:${p.color}">${p.borough}</span>
    </div>`
  ).join('');
}

function selectPersona(id) {
  selectedPersona = PERSONAS.find(p => p.id === id);
  document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('active'));
  document.getElementById(`persona-${id}`).classList.add('active');
  document.getElementById('status-persona').textContent = `${selectedPersona.name} · ${selectedPersona.role} · ${selectedPersona.borough}`;
  updateHour(selectedHour);
  drawClock();
  renderTimeline();
}

// ─────────────────────────────────────────────
// CLOCK (RADIAL)
// ─────────────────────────────────────────────
const R_OUTER = 220;
const R_INNER = 100;
const R_LABEL = 238;

function hourToAngle(h) {
  return (h / 24) * 2 * Math.PI - Math.PI / 2;
}

function polarToXY(angle, r) {
  return { x: Math.cos(angle) * r, y: Math.sin(angle) * r };
}

function describeArc(h, innerR, outerR) {
  const startAngle = hourToAngle(h);
  const endAngle = hourToAngle(h + 1) - 0.01;
  const x1 = Math.cos(startAngle) * outerR;
  const y1 = Math.sin(startAngle) * outerR;
  const x2 = Math.cos(endAngle) * outerR;
  const y2 = Math.sin(endAngle) * outerR;
  const x3 = Math.cos(endAngle) * innerR;
  const y3 = Math.sin(endAngle) * innerR;
  const x4 = Math.cos(startAngle) * innerR;
  const y4 = Math.sin(startAngle) * innerR;
  return `M ${x1} ${y1} A ${outerR} ${outerR} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${innerR} ${innerR} 0 0 0 ${x4} ${y4} Z`;
}

function getDominantColor(sounds) {
  if (!sounds || sounds.length === 0) return '#1e2240';
  const first = sounds[0];
  return SOUND_COLORS[first] || '#a29bfe';
}

function drawClock() {
  const svg = document.getElementById('clock-svg');
  svg.innerHTML = '';

  // defs
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

  // glow filters
  for (const [k,c] of Object.entries(SOUND_COLORS)) {
    const f = document.createElementNS('http://www.w3.org/2000/svg','filter');
    f.setAttribute('id', `glow-${k}`);
    const fe = document.createElementNS('http://www.w3.org/2000/svg','feDropShadow');
    fe.setAttribute('dx','0'); fe.setAttribute('dy','0');
    fe.setAttribute('stdDeviation','6');
    fe.setAttribute('flood-color', c);
    fe.setAttribute('flood-opacity','0.8');
    f.appendChild(fe);
    defs.appendChild(f);
  }
  svg.appendChild(defs);

  // Background rings
  for (let r = R_INNER; r <= R_OUTER; r += (R_OUTER - R_INNER) / 4) {
    const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
    ring.setAttribute('r', r); ring.setAttribute('cx', 0); ring.setAttribute('cy', 0);
    ring.setAttribute('fill','none'); ring.setAttribute('stroke','#1e2240'); ring.setAttribute('stroke-width','0.5');
    svg.appendChild(ring);
  }

  // AM/PM labels
  const amLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
  amLabel.setAttribute('x', 0); amLabel.setAttribute('y', -R_INNER + 25);
  amLabel.setAttribute('text-anchor','middle'); amLabel.setAttribute('class','hour-label');
  amLabel.setAttribute('font-size','7'); amLabel.setAttribute('fill','#3a3f6a');
  amLabel.textContent = 'AM';
  svg.appendChild(amLabel);

  const pmLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
  pmLabel.setAttribute('x', 0); pmLabel.setAttribute('y', R_INNER - 15);
  pmLabel.setAttribute('text-anchor','middle'); pmLabel.setAttribute('class','hour-label');
  pmLabel.setAttribute('font-size','7'); pmLabel.setAttribute('fill','#3a3f6a');
  pmLabel.textContent = 'PM';
  svg.appendChild(pmLabel);

  // Hour segments
  for (let h = 0; h < 24; h++) {
    let sounds = [];
    let db = 0;
    if (selectedPersona) {
      const data = selectedPersona.schedule[h];
      sounds = data.sounds;
      db = data.db;
    }

    const color = getDominantColor(sounds);
    const isSelected = h === selectedHour;
    const dbFactor = db > 0 ? (db - 35) / 65 : 0;
    const segR = R_INNER + dbFactor * (R_OUTER - R_INNER) * 0.95;

    // Main segment
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', describeArc(h, R_INNER, Math.max(R_INNER + 4, segR)));
    path.setAttribute('fill', sounds.length > 0 ? color : '#13162a');
    path.setAttribute('opacity', isSelected ? '1' : sounds.length > 0 ? '0.65' : '0.3');
    if (isSelected && sounds.length > 0) {
      path.setAttribute('filter', `url(#glow-${sounds[0]})`);
    }
    path.setAttribute('stroke', '#070810'); path.setAttribute('stroke-width','1');
    path.style.cursor = 'pointer';
    path.style.transition = 'opacity 0.2s, transform 0.2s';

    const hh = h;
    path.addEventListener('mouseenter', (e) => showTooltip(e, hh));
    path.addEventListener('mousemove', (e) => moveTooltip(e));
    path.addEventListener('mouseleave', () => hideTooltip());
    path.addEventListener('click', () => { updateHour(hh); });
    svg.appendChild(path);

    // Multi-sound dots (stacked thin arcs for additional sounds)
    if (sounds.length > 1) {
      sounds.slice(1).forEach((s, si) => {
        const dotAngle = hourToAngle(h) + (hourToAngle(h+1) - hourToAngle(h)) * 0.5;
        const dotR = R_INNER + 12 + si * 10;
        const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
        dot.setAttribute('cx', Math.cos(dotAngle) * dotR);
        dot.setAttribute('cy', Math.sin(dotAngle) * dotR);
        dot.setAttribute('r', '3');
        dot.setAttribute('fill', SOUND_COLORS[s] || '#666');
        dot.setAttribute('opacity', '0.8');
        dot.style.pointerEvents = 'none';
        svg.appendChild(dot);
      });
    }

    // Hour label
    const midAngle = hourToAngle(h) + (hourToAngle(h+1) - hourToAngle(h)) / 2;
    const labelPos = polarToXY(midAngle, R_LABEL);
    if (h % 3 === 0) {
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', labelPos.x); lbl.setAttribute('y', labelPos.y);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('class','hour-label');
      lbl.setAttribute('font-size','9');
      const displayH = h === 0 ? '12' : h > 12 ? String(h-12) : String(h);
      const suffix = h < 12 ? 'am' : 'pm';
      lbl.textContent = displayH + suffix;
      svg.appendChild(lbl);
    }
  }

  // Center circle
  const centerCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  centerCircle.setAttribute('r', R_INNER - 2);
  centerCircle.setAttribute('fill', '#070810');
  svg.appendChild(centerCircle);

  // Center persona info
  if (selectedPersona) {
    const nameEl = document.createElementNS('http://www.w3.org/2000/svg','text');
    nameEl.setAttribute('x', 0); nameEl.setAttribute('y', -14);
    nameEl.setAttribute('text-anchor','middle');
    nameEl.setAttribute('font-family', 'Syne, sans-serif');
    nameEl.setAttribute('font-weight','700');
    nameEl.setAttribute('font-size','18');
    nameEl.setAttribute('fill', selectedPersona.color);
    nameEl.textContent = selectedPersona.name;
    svg.appendChild(nameEl);

    const roleEl = document.createElementNS('http://www.w3.org/2000/svg','text');
    roleEl.setAttribute('x', 0); roleEl.setAttribute('y', 6);
    roleEl.setAttribute('text-anchor','middle');
    roleEl.setAttribute('font-family', 'DM Mono, monospace');
    roleEl.setAttribute('font-size','8');
    roleEl.setAttribute('fill','#5a5f8a');
    roleEl.textContent = selectedPersona.role;
    svg.appendChild(roleEl);

    const boroughEl = document.createElementNS('http://www.w3.org/2000/svg','text');
    boroughEl.setAttribute('x', 0); boroughEl.setAttribute('y', 20);
    boroughEl.setAttribute('text-anchor','middle');
    boroughEl.setAttribute('font-family', 'DM Mono, monospace');
    boroughEl.setAttribute('font-size','7');
    boroughEl.setAttribute('fill','#3a3f6a');
    boroughEl.textContent = selectedPersona.borough.toUpperCase();
    svg.appendChild(boroughEl);
  } else {
    const hint = document.createElementNS('http://www.w3.org/2000/svg','text');
    hint.setAttribute('x', 0); hint.setAttribute('y', 0);
    hint.setAttribute('text-anchor','middle'); hint.setAttribute('dominant-baseline','middle');
    hint.setAttribute('font-family', 'DM Mono, monospace');
    hint.setAttribute('font-size','8'); hint.setAttribute('fill','#3a3f6a');
    hint.textContent = 'SELECT A PERSONA';
    svg.appendChild(hint);
  }

  // Selected hour indicator needle
  if (selectedPersona) {
    const needleAngle = hourToAngle(selectedHour) + (hourToAngle(selectedHour+1) - hourToAngle(selectedHour))/2;
    const n1 = polarToXY(needleAngle, R_INNER - 6);
    const n2 = polarToXY(needleAngle, R_OUTER + 14);
    const needle = document.createElementNS('http://www.w3.org/2000/svg','line');
    needle.setAttribute('x1', n1.x); needle.setAttribute('y1', n1.y);
    needle.setAttribute('x2', n2.x); needle.setAttribute('y2', n2.y);
    needle.setAttribute('stroke', 'white'); needle.setAttribute('stroke-width','1.5');
    needle.setAttribute('opacity','0.4');
    svg.appendChild(needle);
  }
}

// ─────────────────────────────────────────────
// TOOLTIP
// ─────────────────────────────────────────────
function showTooltip(e, h) {
  const tt = document.getElementById('hour-tooltip');
  const data = selectedPersona ? selectedPersona.schedule[h] : null;
  if (!data) return;

  const displayH = h === 0 ? '12' : h > 12 ? h - 12 : h;
  const suffix = h < 12 ? 'AM' : 'PM';
  document.getElementById('tt-title').textContent = `${displayH}:00 ${suffix} — ${data.loc}`;

  const soundsEl = document.getElementById('tt-sounds');
  soundsEl.innerHTML = data.sounds.map(s =>
    `<span class="sound-chip" style="color:${SOUND_COLORS[s]};border-color:${SOUND_COLORS[s]}">${s}</span>`
  ).join('') || '<span style="color:#3a3f6a;font-size:0.6rem">no tagged sounds</span>';

  document.getElementById('tt-desc').textContent = data.desc;
  tt.classList.add('visible');
  moveTooltip(e);
}

function moveTooltip(e) {
  const tt = document.getElementById('hour-tooltip');
  const rect = document.querySelector('.clock-container').getBoundingClientRect();
  let x = e.clientX - rect.left + 16;
  let y = e.clientY - rect.top - 20;
  if (x + 220 > rect.width) x = e.clientX - rect.left - 230;
  tt.style.left = x + 'px';
  tt.style.top = y + 'px';
}

function hideTooltip() {
  document.getElementById('hour-tooltip').classList.remove('visible');
}

// ─────────────────────────────────────────────
// HOUR UPDATE
// ─────────────────────────────────────────────
function updateHour(h) {
  selectedHour = h;
  if (!selectedPersona) return;

  const data = selectedPersona.schedule[h];
  const displayH = h === 0 ? '12' : h > 12 ? h - 12 : h;
  const suffix = h < 12 ? 'AM' : 'PM';

  document.getElementById('journey-hour-text').textContent = `${displayH}:00 ${suffix}`;
  document.getElementById('journey-location-text').textContent = data.loc;
  document.getElementById('journey-desc-text').textContent = data.desc;

  renderSoundsList(data.sounds, data.db, data.noData);
  animateDbMeter(data.db);
  updateTimeline(h);
  drawClock();

  // Auto-play sounds for this hour
  stopAllSounds();
  if (data.sounds.length > 0) {
    playSoundForType(data.sounds[0], data.db);
  } else {
    playSoundForType('flatline', data.db);
  }
}

// ─────────────────────────────────────────────
// SOUNDS LIST
// ─────────────────────────────────────────────
function renderSoundsList(sounds, db, noData) {
  const el = document.getElementById('sounds-list');
  if (!sounds || sounds.length === 0) {
    if (noData) {
      el.innerHTML = '<div style="color:var(--muted);font-size:0.68rem;margin-top:8px;line-height:1.6">⊘ No sensor data for this hour.<br>One Queens sensor — no overnight coverage.</div>';
    } else {
      el.innerHTML = '<div style="color:var(--muted);font-size:0.68rem;margin-top:8px">Quiet hour — no dominant sounds tagged.</div>';
    }
    return;
  }

  el.innerHTML = sounds.map((s, i) =>
    `<div class="sound-row ${i===0?'playing':''}" id="srow-${s}" onclick="playSoundForType('${s}', ${db})" style="--accent-color:${SOUND_COLORS[s]}">
      <div class="sound-dot" style="background:${SOUND_COLORS[s]};color:${SOUND_COLORS[s]}"></div>
      <div class="sound-name">${s}</div>
      <div class="sound-play-btn">${i===0?'● PLAYING':'▶ PLAY'}</div>
    </div>`
  ).join('');

  // Also show fine-grained sounds
  const detailEl = document.createElement('div');
  detailEl.style.cssText = 'margin-top:10px;padding-top:10px;border-top:1px solid var(--border)';
  detailEl.innerHTML = '<div class="panel-label" style="margin-bottom:8px;font-size:0.58rem">FINE-GRAINED TAGS</div>' +
    sounds.flatMap(s => (SOUND_FINE[s]||[]).slice(0,2)).map(tag =>
      `<div style="font-size:0.63rem;color:var(--muted);padding:2px 0">· ${tag}</div>`
    ).join('');
  el.appendChild(detailEl);
}

// ─────────────────────────────────────────────
// DB METER
// ─────────────────────────────────────────────
function animateDbMeter(targetDb) {
  const fill = document.getElementById('meter-fill');
  const value = document.getElementById('db-value');
  const pct = Math.min(100, Math.max(0, ((targetDb - 40) / 65) * 100));

  let current = parseFloat(fill.style.width) || 0;
  let currentDb = parseInt(value.textContent) || 40;

  const animate = () => {
    current += (pct - current) * 0.08;
    currentDb += (targetDb - currentDb) * 0.08;
    fill.style.width = current + '%';
    value.textContent = Math.round(currentDb);

    if (Math.abs(current - pct) > 0.3) requestAnimationFrame(animate);
    else {
      fill.style.width = pct + '%';
      value.textContent = targetDb;
    }
  };
  requestAnimationFrame(animate);
}

// ─────────────────────────────────────────────
// TIMELINE STRIP
// ─────────────────────────────────────────────
function renderTimeline() {
  const strip = document.getElementById('timeline-strip');
  strip.innerHTML = '';
  for (let h = 0; h < 24; h++) {
    const cell = document.createElement('div');
    cell.className = 'timeline-hour-cell' + (h === selectedHour ? ' current' : '');
    cell.textContent = h;

    let color = '#1e2240';
    if (selectedPersona) {
      const data = selectedPersona.schedule[h];
      color = getDominantColor(data.sounds);
      const db = data.db;
      const alpha = Math.min(1, Math.max(0.15, (db - 40) / 55));
      cell.style.background = color + Math.round(alpha * 255).toString(16).padStart(2,'0');
    } else {
      cell.style.background = '#13162a';
    }
    cell.style.borderRadius = '2px';
    cell.addEventListener('click', () => updateHour(h));
    cell.addEventListener('mouseenter', () => { cell.style.opacity = '0.8'; });
    cell.addEventListener('mouseleave', () => { cell.style.opacity = '1'; });
    strip.appendChild(cell);
  }
}

function updateTimeline(h) {
  document.querySelectorAll('.timeline-hour-cell').forEach((c, i) => {
    c.classList.toggle('current', i === h);
  });
}

// ─────────────────────────────────────────────
// WAVEFORM CANVAS
// ─────────────────────────────────────────────
function resizeWaveform() {
  const canvas = document.getElementById('waveform-canvas');
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
}

function drawWaveform() {
  const canvas = document.getElementById('waveform-canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const color = selectedPersona ? selectedPersona.color : '#a29bfe';

  if (analyserNode && waveformData) {
    analyserNode.getByteTimeDomainData(waveformData);
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5 * window.devicePixelRatio;
    ctx.shadowBlur = 8 * window.devicePixelRatio;
    ctx.shadowColor = color;

    const sliceWidth = W / waveformData.length;
    let x = 0;
    for (let i = 0; i < waveformData.length; i++) {
      const v = waveformData[i] / 128.0;
      const y = (v * H) / 2;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
      x += sliceWidth;
    }
    ctx.stroke();
  } else {
    // Idle animated waveform
    const t = Date.now() / 1000;
    const data = selectedPersona ? selectedPersona.schedule[selectedHour] : null;
    const amp = data ? (data.db - 40) / 65 : 0.05;

    ctx.beginPath();
    ctx.strokeStyle = color + '88';
    ctx.lineWidth = 1.5 * window.devicePixelRatio;
    ctx.shadowBlur = 6 * window.devicePixelRatio;
    ctx.shadowColor = color;

    for (let i = 0; i <= W; i++) {
      const x = i;
      const freq1 = 3, freq2 = 7, freq3 = 13;
      const y = H/2 +
        Math.sin(i/W * Math.PI * freq1 * 2 + t * 1.5) * amp * H * 0.3 +
        Math.sin(i/W * Math.PI * freq2 * 2 + t * 2.3) * amp * H * 0.15 +
        Math.sin(i/W * Math.PI * freq3 * 2 + t * 0.8) * amp * H * 0.1;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // center line
    ctx.beginPath();
    ctx.strokeStyle = '#1e2240';
    ctx.lineWidth = 0.5;
    ctx.shadowBlur = 0;
    ctx.moveTo(0, H/2); ctx.lineTo(W, H/2);
    ctx.stroke();
  }

  animFrameId = requestAnimationFrame(drawWaveform);
}
requestAnimationFrame(drawWaveform);

// ─────────────────────────────────────────────
// WEB AUDIO SYNTHESIS
// Each sound type has a distinct synthesized character
// ─────────────────────────────────────────────
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyserNode = audioCtx.createAnalyser();
    analyserNode.fftSize = 2048;
    waveformData = new Uint8Array(analyserNode.frequencyBinCount);
    analyserNode.connect(audioCtx.destination);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function stopAllSounds() {
  currentSoundNodes.forEach(n => {
    try { n.stop(); } catch(e) {}
  });
  currentSoundNodes = [];
  analyserNode = null;
  waveformData = null;
}

function playSoundForType(type, db) {
  stopAllSounds();
  const ctx = getAudioCtx();

  // Reconnect analyser
  analyserNode = ctx.createAnalyser();
  analyserNode.fftSize = 2048;
  waveformData = new Uint8Array(analyserNode.frequencyBinCount);
  analyserNode.connect(ctx.destination);

  const gainValue = Math.min(0.35, Math.max(0.05, (db - 40) / 70));
  const masterGain = ctx.createGain();
  masterGain.gain.setValueAtTime(0, ctx.currentTime);
  masterGain.gain.linearRampToValueAtTime(gainValue, ctx.currentTime + 0.3);
  masterGain.gain.linearRampToValueAtTime(gainValue * 0.8, ctx.currentTime + 5);
  masterGain.connect(analyserNode);

  const now = ctx.currentTime;

  const synths = {
    engine: () => {
      // Low rumble: multiple detuned oscillators
      [55, 58, 110, 165].forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(freq + Math.random()*3, now);
        osc.frequency.linearRampToValueAtTime(freq * 1.02, now + 2);
        g.gain.setValueAtTime(0.4 - i*0.08, now);
        osc.connect(g); g.connect(masterGain);
        osc.start(now); osc.stop(now + 8);
        currentSoundNodes.push(osc);
      });

      // LFO tremolo
      const lfo = ctx.createOscillator();
      const lfoGain = ctx.createGain();
      lfo.frequency.setValueAtTime(8, now);
      lfoGain.gain.setValueAtTime(5, now);
      lfo.connect(lfoGain);
      lfo.start(now); lfo.stop(now + 8);
      currentSoundNodes.push(lfo);
    },
    machinery: () => {
      // Rhythmic mechanical impacts
      const rhythmStep = 0.22;
      for (let i = 0; i < 20; i++) {
        const t = now + i * rhythmStep;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(120 + (i%3)*40, t);
        osc.frequency.exponentialRampToValueAtTime(60, t + 0.08);
        g.gain.setValueAtTime(0.6, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
        osc.connect(g); g.connect(masterGain);
        osc.start(t); osc.stop(t + 0.15);
        currentSoundNodes.push(osc);
      }
    },
    impact: () => {
      // Sharp thud
      for (let i = 0; i < 6; i++) {
        const t = now + i * 0.7 + Math.random()*0.2;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(200, t);
        osc.frequency.exponentialRampToValueAtTime(40, t + 0.15);
        g.gain.setValueAtTime(0.8, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        osc.connect(g); g.connect(masterGain);
        osc.start(t); osc.stop(t + 0.25);
        currentSoundNodes.push(osc);
      }
    },
    saw: () => {
      // High-pitched whine
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(1800, now);
      osc.frequency.setValueAtTime(2400, now + 1.2);
      osc.frequency.setValueAtTime(1600, now + 2.5);
      osc.frequency.setValueAtTime(2200, now + 4);
      g.gain.setValueAtTime(0.15, now);
      osc.connect(g); g.connect(masterGain);
      osc.start(now); osc.stop(now + 6);
      currentSoundNodes.push(osc);
    },
    alert: () => {
      // Siren-like alternating tone
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      for (let i = 0; i < 8; i++) {
        osc.frequency.setValueAtTime(i%2===0 ? 880 : 660, now + i * 0.5);
      }
      g.gain.setValueAtTime(0.4, now);
      osc.connect(g); g.connect(masterGain);
      osc.start(now); osc.stop(now + 5);
      currentSoundNodes.push(osc);
    },
    music: () => {
      // Warm chord progression
      const notes = [261.6, 329.6, 392, 493.9]; // C E G B
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, now);
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.2 - i*0.03, now + 0.3 + i*0.1);
        g.gain.linearRampToValueAtTime(0.15, now + 4);
        osc.connect(g); g.connect(masterGain);
        osc.start(now); osc.stop(now + 7);
        currentSoundNodes.push(osc);
      });
    },
    voice: () => {
      // Formant-like babble
      const freqs = [200, 450, 800, 1200];
      freqs.forEach((f, i) => {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(f, now);
        osc.frequency.linearRampToValueAtTime(f * (1 + Math.sin(i) * 0.1), now + 3);
        g.gain.setValueAtTime(0.12 - i*0.02, now);
        osc.connect(g); g.connect(masterGain);
        osc.start(now); osc.stop(now + 6);
        currentSoundNodes.push(osc);
      });
    },
    dog: () => {
      // Short bark bursts
      for (let i = 0; i < 3; i++) {
        const t = now + i * 1.4;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(380, t);
        osc.frequency.exponentialRampToValueAtTime(260, t + 0.12);
        g.gain.setValueAtTime(0.5, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
        osc.connect(g); g.connect(masterGain);
        osc.start(t); osc.stop(t + 0.22);
        currentSoundNodes.push(osc);
      }
    },

    // flatline: no sounds this hour — very faint drone, skips masterGain so it stays audible
    // connects directly to analyserNode at a fixed low level
    flatline: () => {
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(100, now);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.018, now + 1.5); // slow fade in, stays barely there
      osc.connect(g); g.connect(analyserNode); // bypass masterGain — fixed level regardless of db
      osc.start(now); osc.stop(now + 8);
      currentSoundNodes.push(osc);
    },

    // busking: outdoor performance — plucked chord strum, more energetic than ambient music
    busking: () => {
      const strings = [164, 196, 247, 330, 392]; // open Em voicing
      const strum = (startTime, freqMult) => {
        strings.forEach((freq, i) => {
          const t = startTime + i * 0.032;
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(freq * freqMult, t);
          g.gain.setValueAtTime(0.28 - i * 0.04, t);
          g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
          osc.connect(g); g.connect(masterGain);
          osc.start(t); osc.stop(t + 1.7);
          currentSoundNodes.push(osc);
        });
      };
      strum(now, 1);        // Em
      strum(now + 2.2, 1.335); // Am-ish (up a fourth)
      strum(now + 4.2, 1.189); // somewhere between — like a walking chord
    },
  };

  // Execute the synth for this type
  if (synths[type]) synths[type]();

  // Update UI
  document.querySelectorAll('.sound-row').forEach(r => {
    r.classList.remove('playing');
    r.querySelector('.sound-play-btn').textContent = '▶ PLAY';
  });
  const row = document.getElementById(`srow-${type}`);
  if (row) {
    row.classList.add('playing');
    row.querySelector('.sound-play-btn').textContent = '● PLAYING';
  }
}

// ─────────────────────────────────────────────
// AUTO-PLAY
// ─────────────────────────────────────────────
function toggleAutoPlay() {
  if (!selectedPersona) return;
  const btn = document.getElementById('play-btn');
  if (isAutoPlaying) {
    clearInterval(autoPlayInterval);
    isAutoPlaying = false;
    stopAllSounds();
    btn.textContent = '▶ AUTO-PLAY DAY';
    btn.classList.remove('active');
  } else {
    isAutoPlaying = true;
    btn.textContent = '■ STOP';
    btn.classList.add('active');
    updateHour(selectedHour);
    autoPlayInterval = setInterval(() => {
      selectedHour = (selectedHour + 1) % 24;
      updateHour(selectedHour);
    }, 3000);
  }
}

// ─────────────────────────────────────────────
// START
// ─────────────────────────────────────────────
init();
</script>
</body>
</html>
